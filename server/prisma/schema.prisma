// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Configure Prisma seed
// Prisma will run `npm run db:seed` when `prisma db seed` is executed
// See package.json scripts

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String?  @map("first_name")
  lastName     String?  @map("last_name")
  role         UserRole @default(RECRUITER)
  companyId    Int?     @map("company_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Subscription fields
  subscriptionPlan      SubscriptionPlan?   @map("subscription_plan")
  subscriptionStatus    SubscriptionStatus? @map("subscription_status")
  subscriptionStartedAt DateTime?           @map("subscription_started_at")
  subscriptionExpiresAt DateTime?           @map("subscription_expires_at")

  // Relations
  company     Company?         @relation(fields: [companyId], references: [id], onDelete: SetNull)
  jobs        Job[]
  candidates  Candidate[]
  savedJobs   SavedJob[]

  @@map("users")
}

model Job {
  id           Int       @id @default(autoincrement())
  title        String
  description  String
  requirements String?
  location     String?
  salaryRange  String?   @map("salary_range")
  status       JobStatus @default(DRAFT)
  userId       Int       @map("user_id")
  companyId    Int?      @map("company_id")
  publishedAt  DateTime? @map("published_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  company         Company?         @relation(fields: [companyId], references: [id], onDelete: SetNull)
  jobApplications JobApplication[]
  savedBy         SavedJob[]

  @@map("jobs")
}

model Candidate {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id") // recruiter/tenant owner
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  email     String   @map("email")
  phone     String?  @map("phone")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  applications JobApplication[]

  @@unique([userId, email])
  @@map("candidates")
}

model JobApplication {
  id              Int               @id @default(autoincrement())
  jobId           Int               @map("job_id")
  candidateId     Int               @map("candidate_id") 
  firstName       String            @map("first_name")
  lastName        String            @map("last_name")
  email           String
  phone           String?
  coverLetter     String?           @map("cover_letter")
  linkedinUrl     String?           @map("linkedin_url")
  portfolioUrl    String?           @map("portfolio_url")
  yearsExperience Int?              @map("years_experience")
  status          ApplicationStatus @default(SUBMITTED)
  resumeId        Int?              @map("resume_id")
  trackingToken   String            @unique @map("tracking_token")
  source          String?           @default("website")
  notes           String?
  reviewedBy      Int?              @map("reviewed_by")
  reviewedAt      DateTime?         @map("reviewed_at")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  job       Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  resume    Resume?   @relation(fields: [resumeId], references: [id], onDelete: SetNull)
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([jobId, status])
  @@index([email])
  @@index([trackingToken])
  @@index([candidateId])
  @@map("job_applications")
}

model Resume {
  id           Int      @id @default(autoincrement())
  originalName String   @map("original_name")
  fileName     String   @map("file_name")
  filePath     String   @map("file_path")
  fileSize     Int      @map("file_size")
  mimeType     String   @map("mime_type")
  extractedText String? @map("extracted_text")
  parsedData   Json?    @map("parsed_data")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")

  applications JobApplication[]

  @@map("resumes")
}

model SavedJob {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  jobId     Int      @map("job_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([userId])
  @@index([jobId])
  @@map("saved_jobs")
}

model Company {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users User[]
  jobs  Job[]

  @@map("companies")
}


enum ApplicationStatus {
  SUBMITTED       // Initial submission
  IN_REVIEW    // Being reviewed by recruiter
  SHORTLISTED     // Passed initial screening
  INTERVIEW_SCHEDULED  // Interview scheduled
  INTERVIEWED     // Interview completed
  OFFER_EXTENDED  // Job offer sent
  HIRED           // Accepted offer
  REJECTED        // Application rejected
  WITHDRAWN       // Candidate withdrew
}

// Enums
enum UserRole {
  ADMIN
  RECRUITER
  EMPLOYEE
}

enum JobStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

// Subscription plans for HR/Recruiter and Employee
enum SubscriptionPlan {
  // HR/Recruiter plans
  BASIC
  PROFESSIONAL
  ENTERPRISE
  // Employee plans
  TRIAL
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum Title {
  MR
  MS
  DR
}